# PowerUp Integration Guide

## Overview

The Voice Walkie-Talkie service now integrates with your PowerUp system to create Socratic teaching conversations. The AI can fetch content context from your database and initiate conversations with learners.

## New Features

### 1. **Database Integration**
- Fetches PowerUp content from `powerup_metadata` table
- Retrieves title, theme, key topics, transcript, and context
- Automatically builds Socratic teaching prompts

### 2. **AI-First Conversations**
- AI can send the first voice message
- Opens with warm, conversational greeting
- References specific PowerUp content
- Asks open-ended questions to start discussion

### 3. **Socratic Teaching Mode**
- Custom system prompts for each PowerUp
- Guides learners through content understanding
- Asks probing questions without lecturing
- Detects and challenges vague answers

### 4. **Session Tracking**
- Saves proof-of-understanding results
- Tracks topics covered
- Records pass/fail status
- Stores evaluation reasoning

---

## API Usage

### Start PowerUp Session with AI-First Message

```http
POST /api/v1/voice-walkie/session/start
Content-Type: application/json

{
  "user_id": "user_123",
  "powerup_id": 42,
  "ai_speaks_first": true,
  "voice_name": "Puck"
}
```

**Response**:
```json
{
  "session_id": "wt_abc123...",
  "google_api_key": "AIza...",
  "ws_endpoint": "wss://...",
  "config": {...},
  "powerup_context": {
    "id": 42,
    "title": "The Power of Vulnerability",
    "theme": "Leadership & Communication",
    "key_topics": ["authenticity", "courage", "connection"],
    "context": "...",
    "transcript": "..."
  },
  "first_message": "Hey! So you just watched 'The Power of Vulnerability' - that's some heavy stuff. What did you think about it? What stood out to you?"
}
```

### Get All PowerUp Contexts

```http
GET /api/v1/voice-walkie/powerup/contexts
```

**Response**:
```json
{
  "count": 10,
  "contexts": [
    {
      "id": 42,
      "title": "The Power of Vulnerability",
      "theme": "Leadership",
      "created_at": "2025-12-20T10:00:00Z"
    },
    ...
  ]
}
```

### Get Specific PowerUp Context

```http
GET /api/v1/voice-walkie/powerup/42
```

### Save Session Results

```http
POST /api/v1/voice-walkie/powerup/session/save
Content-Type: application/json

{
  "powerup_id": 42,
  "learner_name": "John Doe",
  "passed": true,
  "topics_covered": ["authenticity", "vulnerability", "leadership"],
  "exchange_count": 15,
  "evaluation_reason": "Demonstrated deep understanding of all key concepts"
}
```

---

## Database Setup

### Required Tables

#### 1. `powerup_metadata` (Already exists in your system)
```sql
-- Your existing table structure
```

#### 2. `powerup_sessions` (Create this table)
```sql
CREATE TABLE public.powerup_sessions (
    id bigint generated by default as identity primary key,
    powerup_id bigint not null,
    learner_name text not null,
    passed boolean not null,
    topics_covered jsonb null,
    exchange_count int null,
    evaluation_reason text null,
    session_timestamp timestamp with time zone not null default now()
);

-- Add foreign key constraint
ALTER TABLE public.powerup_sessions
ADD CONSTRAINT fk_powerup
FOREIGN KEY (powerup_id) 
REFERENCES public.powerup_metadata(id);

-- Add index for queries
CREATE INDEX idx_powerup_sessions_powerup_id 
ON public.powerup_sessions(powerup_id);

CREATE INDEX idx_powerup_sessions_learner 
ON public.powerup_sessions(learner_name);
```

### Environment Variables

Add to your `.env`:
```bash
# Existing
GOOGLE_API_KEY=your_google_api_key

# PowerUp Integration (if not already set)
SUPABASE_URL=your_supabase_url
SUPABASE_KEY=your_supabase_key
```

---

## React Native Integration

### Starting a PowerUp Session

```javascript
import WalkieTalkieService from './services/WalkieTalkieService';

// Start session with PowerUp context
const service = new WalkieTalkieService(BACKEND_URL);

const response = await fetch(`${BACKEND_URL}/api/v1/voice-walkie/session/start`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${JWT_TOKEN}`,
  },
  body: JSON.stringify({
    user_id: userId,
    powerup_id: 42,  // Specific PowerUp content
    ai_speaks_first: true,  // AI sends first message
    voice_name: 'Puck',
  }),
});

const session = await response.json();

// Initialize WebSocket
await service.initializeWithSession(session);

// If AI speaks first, play the first message
if (session.first_message) {
  console.log('AI says:', session.first_message);
  // The actual audio would come through WebSocket
}

// User can now respond
await service.startRecording();  // On mic button press
await service.stopRecording();   // On mic button release
```

### Handling AI-First Messages

```javascript
class WalkieTalkieService {
  async initializeWithSession(sessionData) {
    this.sessionId = sessionData.session_id;
    this.wsEndpoint = sessionData.ws_endpoint;
    this.config = sessionData.config;
    
    // Connect WebSocket
    await this._connectWebSocket();
    
    // If AI speaks first, wait for initial response
    if (sessionData.first_message) {
      // The WebSocket will receive the audio response
      // after setup is complete
      this.waitingForFirstMessage = true;
    }
  }
  
  _handleWebSocketMessage(event) {
    const message = JSON.parse(event.data);
    
    // Handle first AI message
    if (this.waitingForFirstMessage && message.server_content) {
      this.waitingForFirstMessage = false;
      console.log('Received AI\'s first message!');
      // Play audio response
      this._playAudioResponse(message.server_content.model_turn.parts);
    }
    
    // ... rest of message handling
  }
}
```

---

## System Prompt Behavior

### Socratic Teaching Mode

When a PowerUp context is loaded, the AI automatically:

1. **Knows the Content**: Has access to full transcript and key topics
2. **Guides, Doesn't Teach**: Uses questions, not explanations
3. **Detects BS**: Challenges vague or superficial answers
4. **Stays Conversational**: Friendly but intellectually rigorous
5. **Covers Key Topics**: Naturally touches on all important themes

### Example Conversation Flow

```
AI (First Message):
"Hey! So you just watched 'The Power of Vulnerability' - 
BrenÃ© Brown's talk, right? Pretty intense stuff. 
What was your initial reaction to it?"

User:
"It was good. I liked it."

AI (Pushing Back):
"That's a start, but I need you to go deeper. What SPECIFICALLY 
made sense to you? Give me something concrete."

User:
"Well, the part about how showing vulnerability actually 
makes you stronger was interesting."

AI (Probing Deeper):
"Interesting how? Can you give me an example from your own 
life where you've seen that play out?"

... (conversation continues naturally)
```

---

## Testing

### Test PowerUp Integration

```bash
# Start your server
uvicorn app.main:app --reload

# Test fetching PowerUp contexts
curl http://localhost:8000/api/v1/voice-walkie/powerup/contexts

# Test starting a PowerUp session
curl -X POST http://localhost:8000/api/v1/voice-walkie/session/start \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test_user",
    "powerup_id": 1,
    "ai_speaks_first": true
  }'
```

---

## Migration from Existing System

If you already have PowerUp code elsewhere, here's how to integrate:

1. **Keep your existing** `fetch_powerup_context()` function
2. **Use the new** PowerUp integration class for walkie-talkie sessions
3. **Both can coexist** - they access the same database tables

---

## Cost Implications

**AI-First Messages**:
- Adds ~100-200 tokens per session start
- Cost: ~$0.0001 - $0.0002 per session
- Negligible impact on overall costs

**Longer Conversations**:
- PowerUp sessions typically 5-15 minutes
- More exchanges = better learning
- Still very cost-effective with Gemini 3 Flash

---

## Next Steps

1. âœ… Add Supabase credentials to `.env`
2. âœ… Create `powerup_sessions` table
3. âœ… Test PowerUp context fetching
4. âœ… Update mobile app to use new endpoints
5. âœ… Test AI-first message flow
6. âœ… Monitor session results in database

The PowerUp integration is now fully implemented and ready to use! ðŸŽ“

